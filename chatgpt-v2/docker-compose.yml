version: "3.9"

services:
  traefik:
    container_name: ai-traefik
    image: traefik:v3.1
    command:
      # Core
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedByDefault=false"

      # File provider for dynamic config (middlewares, rate limits, etc.)
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # Let's Encrypt
      - "--certificatesresolvers.le.acme.httpchallenge=true"
      - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.le.acme.email=${TRAEFIK_ACME_EMAIL}"
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - "./traefik/letsencrypt:/letsencrypt"
      - "./traefik/dynamic:/etc/traefik/dynamic"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

    restart: unless-stopped

  backend:
    container_name: ai-backend
    build:
      context: ./backend
      dockerfile: Dockerfile

    env_file:
      - ./backend/.env
      - ./.env

    depends_on:
      postgres:
        condition: service_healthy

    volumes:
      # - ./backend:/app
      - /app/node_modules

    labels:
      - "traefik.enable=true"

      # HTTPS router for backend: https://api.example.com
      - "traefik.http.routers.backend-secure.rule=Host(`${BACKEND_SUBDOMAIN}.${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.backend-secure.entrypoints=websecure"
      - "traefik.http.routers.backend-secure.tls.certresolver=le"
      - "traefik.http.services.backend.loadbalancer.server.port=3000"
      - "traefik.http.routers.backend-secure.middlewares=security-headers@file,backend-cors@file,backend-ratelimit@file"

      # HTTP → HTTPS redirect for backend
      - "traefik.http.routers.backend.rule=Host(`${BACKEND_SUBDOMAIN}.${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.middlewares=https-redirect@file"

  frontend:
    container_name: ai-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile

    env_file:
      - ./.env

    depends_on:
      - backend

    labels:
      - "traefik.enable=true"

      # HTTPS router for frontend: https://ai.example.com
      - "traefik.http.routers.frontend-secure.rule=Host(`${FRONTEND_SUBDOMAIN}.${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.frontend-secure.entrypoints=websecure"
      - "traefik.http.routers.frontend-secure.tls.certresolver=le"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "traefik.http.routers.frontend-secure.middlewares=security-headers@file,frontend-ratelimit@file"

      # HTTP → HTTPS redirect for frontend
      - "traefik.http.routers.frontend.rule=Host(`${FRONTEND_SUBDOMAIN}.${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.middlewares=https-redirect@file"

  postgres:
    container_name: ai-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - "E:/T_Script/dockerApp/ai-platforms/chatgpt-v2/backend/db/init.sql:/docker-entrypoint-initdb.d/001-init.sql:ro"
      - "E:/T_Script/dockerApp/ai-platforms/chatgpt-v2/backend/db/seed.sql:/docker-entrypoint-initdb.d/002-seed.sql:ro"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-ai_platform}"]
      interval: 5s
      timeout: 3s
      retries: 30

  pgadmin:
    container_name: ai-pgadmin
    image: dpage/pgadmin4:8.6
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
    ports:
      - "${PGADMIN_PORT}:80"
    depends_on:
      - postgres
    restart: unless-stopped

volumes:
  postgres_data:
