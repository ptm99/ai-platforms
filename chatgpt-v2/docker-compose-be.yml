# version: "3.9"

services:
  # traefik:
  #   container_name: ai-traefik
  #   image: traefik:v3.1
  #   command:
  #     # Core
  #     - "--api.dashboard=true"
  #     - "--providers.docker=true"
  #     - "--providers.docker.exposedByDefault=false"

  #     # File provider for middlewares
  #     - "--providers.file.directory=/etc/traefik/dynamic"
  #     - "--providers.file.watch=true"

  #     # Entrypoints
  #     - "--entrypoints.web.address=:80"
  #     - "--entrypoints.websecure.address=:443"

  #     # Let's Encrypt (note: requires PUBLIC_DOMAIN to be a real public domain)
  #     - "--certificatesresolvers.le.acme.httpchallenge=true"
  #     - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
  #     - "--certificatesresolvers.le.acme.email=${TRAEFIK_ACME_EMAIL}"
  #     - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"

  #   ports:
  #     - "80:80"
  #     - "443:443"
  #     # Optional: expose dashboard locally
  #     - "8080:8080"

  #   volumes:
  #     - "./traefik/letsencrypt:/letsencrypt"
  #     - "./traefik/dynamic:/etc/traefik/dynamic"
  #     - "/var/run/docker.sock:/var/run/docker.sock:ro"

  #   restart: unless-stopped

  postgres:
    container_name: ai-postgres
    image: postgres:18.1-alpine3.23
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/db/init.sql:/docker-entrypoint-initdb.d/001-init.sql:ro
      - ./backend/db/seed.sql:/docker-entrypoint-initdb.d/002-seed.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  pgadmin:
    container_name: ai-pgadmin
    image: dpage/pgadmin4:9.11
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
    ports:
      - "${PGADMIN_PORT}:80"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  backend:
    container_name: ai-backend
    build:
      context: ./backend
      dockerfile: Dockerfile

    # Load both env files (root for shared vars; backend/.env optional)
    env_file:
      - ./.env
      - ./backend/.env

    environment:
      # Normalize env var names expected by backend code
      PORT: ${BACKEND_PORT}

      # Build DATABASE_URL from your Postgres vars (works even if backend/.env is absent)
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}

      # Backward-compatible mapping from your existing .env names:
      # - backend expects KEY_ENC_SECRET, JWT_ACCESS_SECRET, JWT_REFRESH_SECRET
      KEY_ENC_SECRET: ${API_KEY_ENCRYPTION_SECRET}
      JWT_ACCESS_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_SECRET}

      # Optional expirations (backend uses defaults if missing)
      JWT_ACCESS_EXPIRES_IN: ${JWT_ACCESS_EXPIRES_IN}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN}

      # Feature flags mapped to backend expected names
      MODEL_DISCOVERY_ENABLED: ${ENABLE_MODEL_DISCOVERY}
      # If you need cron schedule:
      MODEL_DISCOVERY_CRON: ${MODEL_DISCOVERY_CRON}

      # CORS
      CORS_ORIGIN: ${CORS_ORIGIN}

    depends_on:
      postgres:
        condition: service_healthy

    # If you want dev hot reload, keep volumes; for “backend first build stability”, remove volumes.
    # Recommended: comment these out until build is stable, then re-enable for dev.
    # volumes:
    #   - ./backend:/app
    #   - /app/node_modules

    labels:
      - "traefik.enable=true"

      # HTTPS router for backend: https://api.example.com
      - "traefik.http.routers.backend-secure.rule=Host(`${BACKEND_SUBDOMAIN}.${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.backend-secure.entrypoints=websecure"
      - "traefik.http.routers.backend-secure.tls.certresolver=le"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
      - "traefik.http.routers.backend-secure.middlewares=security-headers@file,backend-cors@file,backend-ratelimit@file"

      # HTTP → HTTPS redirect
      - "traefik.http.routers.backend.rule=Host(`${BACKEND_SUBDOMAIN}.${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.middlewares=https-redirect@file"

    restart: unless-stopped

volumes:
  postgres_data:
